<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tienda - Plappy Pird</title>
  <script src="/env.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Press Start 2P', cursive;
      background-color: #333366;
      margin: 0;
      padding: 20px;
      color: white;
      min-height: 100vh;
    }

    #shop-container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #222244;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    h1 {
      text-align: center;
      color: #ffcc00;
      text-shadow: 3px 3px 0px black;
      margin-bottom: 30px;
      font-size: 24px;
    }

    .items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .item {
      border: 3px solid #ffaa00;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      background-color: #333355;
    }

    .item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
    }

    .item img {
      width: 80px;
      height: 80px;
      image-rendering: pixelated;
      border: 2px solid #ffaa00;
      border-radius: 5px;
      margin-bottom: 15px;
    }

    .item p {
      font-size: 12px;
      margin: 10px 0;
      color: white;
      line-height: 1.4;
    }

    .skin-name {
      color: #ffcc00;
      font-size: 14px;
      margin-bottom: 15px !important;
    }

    .price-text {
      color: #66ff66;
      font-weight: bold;
    }

    .buy-btn {
      margin-top: 15px;
      background-color: #ffcc00;
      border: 3px solid #ffaa00;
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 5px;
      box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.5);
      transition: all 0.3s ease;
      color: #333366;
      width: 100%;
    }

    .buy-btn:hover {
      background-color: #ffaa00;
      transform: translateY(-2px);
    }

    .buy-btn:active {
      transform: scale(0.95);
    }

    .back-btn, .toSkins-btn, .add-skin-btn {
      font-family: 'Press Start 2P', cursive;
      padding: 12px 20px;
      background-color: #ffcc00;
      border: 3px solid #ffaa00;
      border-radius: 8px;
      font-size: 12px;
      box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.5);
      cursor: pointer;
      color: #333366;
      transition: all 0.3s ease;
    }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
    }

    .toSkins-btn {
      position: absolute;
      top: 20px;
      right: 20px;
    }

    /* Nuevo botón para agregar skin */
    .add-skin-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: #66ff66;
      border-color: #44dd44;
    }

    .add-skin-btn:hover {
      background-color: #44dd44;
      transform: translateY(-2px);
    }

    .back-btn:hover, .toSkins-btn:hover {
      background-color: #ffaa00;
      transform: translateY(-2px);
    }

    /* Rareza aplicada al fondo del item */
    .common {
      background-color: #444466;
      border-color: #666688;
    }

    .rare {
      background: linear-gradient(135deg, #4488cc, #3366aa);
      border-color: #66aaee;
    }

    .epic {
      background: linear-gradient(135deg, #aa66cc, #8844aa);
      border-color: #cc88ee;
      animation: soft-glow 2s infinite alternate;
    }

    @keyframes soft-glow {
      from {
        box-shadow: 0 0 10px rgba(170, 102, 204, 0.5);
      }
      to {
        box-shadow: 0 0 20px rgba(170, 102, 204, 0.8);
      }
    }

    .legendary {
      background: linear-gradient(135deg, #ffcc00, #ff9900);
      border-color: #ffdd33;
      animation: glow 1.5s infinite alternate;
      color: #333366;
    }

    .legendary p {
      color: #333366;
    }

    .legendary .skin-name {
      color: #662200;
    }

    @keyframes glow {
      from {
        box-shadow: 0 0 15px rgba(255, 204, 0, 0.6);
      }
      to {
        box-shadow: 0 0 30px rgba(255, 153, 0, 0.9);
      }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background-color: #222244;
      margin: 5% auto;
      padding: 30px;
      border: 3px solid #ffaa00;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
      position: relative;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal h2 {
      color: #ffcc00;
      text-align: center;
      margin-bottom: 25px;
      font-size: 18px;
      text-shadow: 2px 2px 0px black;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: white;
      margin-bottom: 8px;
      font-size: 10px;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ffaa00;
      background-color: #333355;
      color: white;
      border-radius: 5px;
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      box-sizing: border-box;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #ffcc00;
      box-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
    }

    .form-group select option {
      background-color: #333355;
      color: white;
    }

    /* Estilos específicos para el input de archivo */
    .form-group input[type="file"] {
      padding: 8px;
      font-size: 8px;
      background-color: #444466;
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
    }

    .modal-btn {
      font-family: 'Press Start 2P', cursive;
      padding: 12px 20px;
      border: 3px solid #ffaa00;
      border-radius: 8px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.5);
    }

    .save-btn {
      background-color: #66ff66;
      color: #333366;
    }

    .save-btn:hover {
      background-color: #44dd44;
      transform: translateY(-2px);
    }

    .cancel-btn {
      background-color: #ff6666;
      color: white;
    }

    .cancel-btn:hover {
      background-color: #dd4444;
      transform: translateY(-2px);
    }

    .close {
      color: #ffaa00;
      float: right;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      top: 15px;
      right: 20px;
    }

    .close:hover {
      color: #ffcc00;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      #shop-container {
        padding: 15px;
      }

      .items {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .back-btn, .toSkins-btn, .add-skin-btn {
        padding: 10px 15px;
        font-size: 10px;
      }

      .add-skin-btn {
        top: 60px;
        right: 10px;
      }

      h1 {
        font-size: 18px;
        margin-top: 100px;
      }

      .modal-content {
        width: 95%;
        margin: 10% auto;
        padding: 20px;
      }

      .modal-buttons {
        flex-direction: column;
      }
    }

  </style>
</head>
<body>
<div id="shop-container">
  <button class="back-btn" onclick="navigateTo('AdminMenu.html')">Volver</button>
  <button class="add-skin-btn" onclick="abrirModalAgregar()">+ Agregar Skin</button>
  <h1>Panel de Modificación de Skins</h1>

  <div class="items" id="skins-container">
    <!-- Las skins se cargarán aquí dinámicamente -->
  </div>
</div>

<!-- Modal para modificar skin -->
<div id="modifyModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Modificar Skin</h2>
    <form id="modifyForm">
      <div class="form-group">
        <label for="skinName">Nombre de la Skin:</label>
        <input type="text" id="skinName" name="skinName" required>
      </div>

      <div class="form-group">
        <label for="skinRarity">Rareza:</label>
        <select id="skinRarity" name="skinRarity" required>
          <option value="común">Común</option>
          <option value="raro">Raro</option>
          <option value="épico">Épico</option>
          <option value="legendario">Legendario</option>
        </select>
      </div>

      <div class="form-group">
        <label for="skinPrice">Precio (monedas):</label>
        <input type="number" id="skinPrice" name="skinPrice" min="0" required>
      </div>

      <div class="modal-buttons">
        <button type="button" class="modal-btn save-btn" onclick="guardarCambios()">Guardar</button>
        <button type="button" class="modal-btn cancel-btn" onclick="cerrarModal()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para agregar nueva skin -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="cerrarModalAgregar()">&times;</span>
    <h2>Agregar Nueva Skin</h2>
    <form id="addForm" enctype="multipart/form-data">
      <div class="form-group">
        <label for="newSkinName">Nombre de la Skin:</label>
        <input type="text" id="newSkinName" name="newSkinName" required>
      </div>

      <div class="form-group">
        <label for="newSkinRarity">Rareza:</label>
        <select id="newSkinRarity" name="newSkinRarity" required>
          <option value="común">Común</option>
          <option value="raro">Raro</option>
          <option value="épico">Épico</option>
          <option value="legendario">Legendario</option>
        </select>
      </div>

      <div class="form-group">
        <label for="newSkinPrice">Precio (monedas):</label>
        <input type="number" id="newSkinPrice" name="newSkinPrice" min="0" required>
      </div>

      <div class="form-group">
        <label for="skinImage">Imagen de la Skin:</label>
        <input type="file" id="skinImage" name="skinImage" accept="image/*" required>
      </div>

      <div class="modal-buttons">
        <button type="button" class="modal-btn save-btn" onclick="agregarSkin()">Agregar</button>
        <button type="button" class="modal-btn cancel-btn" onclick="cerrarModalAgregar()">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
  const BASE_URL = window.ENV.BASE_URL;
  let currentSkinId = null;

  function getUserId(){
    const token = localStorage.getItem("token");
    return parseJwt(token).userId;
  }

  if(!localStorage.getItem("token")){
    navigateTo("WebMenu.html");
  }

  function navigateTo(page) {
    window.location.href = page;
  }

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) {
      return null;
    }
  }

  async function cargarSkins() {
    const userId = getUserId();

    try {
      const response = await fetch(`${BASE_URL}/shop/get-all-skins`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({})
      });

      const skins = await response.json();
      const container = document.getElementById("skins-container");

      skins.forEach(skin => {
        const skinDiv = document.createElement("div");
        skinDiv.classList.add("item");

        switch (skin.rarity) {
          case "común":
            skinDiv.classList.add("common");
            break;
          case "raro":
            skinDiv.classList.add("rare");
            break;
          case "épico":
            skinDiv.classList.add("epic");
            break;
          case "legendario":
            skinDiv.classList.add("legendary");
            break;
        }

        skinDiv.innerHTML = `
          <p class="skin-name">${skin.name}</p>
          <img src="${skin.image_url}" alt="${skin.name}" />
          <p class="price-text">Precio: ${skin.price} monedas</p>
          <button class="buy-btn" onclick="modificarSkin(${skin.skin_id}, '${skin.name}', '${skin.rarity}', ${skin.price})">Modificar</button>
        `;

        container.appendChild(skinDiv);
      });

    } catch (err) {
      console.error("Error al cargar skins:", err);
      alert("No se pudieron cargar las skins.");
    }
  }

  function modificarSkin(skinId, skinName, skinRarity, skinPrice) {
    currentSkinId = skinId;

    // Llenar el formulario con los datos actuales
    document.getElementById('skinName').value = skinName;
    document.getElementById('skinRarity').value = skinRarity;
    document.getElementById('skinPrice').value = skinPrice;

    // Mostrar el modal
    document.getElementById('modifyModal').style.display = 'block';
  }

  function cerrarModal() {
    document.getElementById('modifyModal').style.display = 'none';
    currentSkinId = null;
  }

  function abrirModalAgregar() {
    // Limpiar el formulario
    document.getElementById('addForm').reset();
    // Mostrar el modal
    document.getElementById('addModal').style.display = 'block';
  }

  function cerrarModalAgregar() {
    document.getElementById('addModal').style.display = 'none';
  }

  async function agregarSkin() {
    const skinName = document.getElementById('newSkinName').value.trim();
    const skinRarity = document.getElementById('newSkinRarity').value;
    const skinPrice = parseInt(document.getElementById('newSkinPrice').value);
    const skinImage = document.getElementById('skinImage').files[0];

    if (!skinName || !skinRarity || skinPrice < 0 || !skinImage) {
      alert('Por favor, completa todos los campos correctamente y selecciona una imagen');
      return;
    }

    // Crear FormData para enviar el archivo
    const formData = new FormData();
    formData.append('skin_name', skinName);
    formData.append('skin_rarity', skinRarity);
    formData.append('skin_price', skinPrice);
    formData.append('skin_image', skinImage);

    try {
      const token = localStorage.getItem("token");
      const response = await fetch(`${BASE_URL}/admin/add-skin`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`
          // No incluir Content-Type aquí, el navegador lo establecerá automáticamente con boundary para multipart/form-data
        },
        body: formData
      });

      const result = await response.json();

      if (response.ok) {
        alert('Skin agregada exitosamente');
        cerrarModalAgregar();
        // Recargar las skins para mostrar la nueva skin
        document.getElementById('skins-container').innerHTML = '';
        cargarSkins();
      } else {
        alert(`Error: ${result.message}`);
      }

    } catch (err) {
      console.error("Error al agregar skin:", err);
      alert("Error al agregar la skin. Inténtalo de nuevo.");
    }
  }

  async function guardarCambios() {
    if (!currentSkinId) {
      alert('Error: No se ha seleccionado ninguna skin');
      return;
    }

    const skinName = document.getElementById('skinName').value.trim();
    const skinRarity = document.getElementById('skinRarity').value;
    const skinPrice = parseInt(document.getElementById('skinPrice').value);

    if (!skinName || !skinRarity || skinPrice < 0) {
      alert('Por favor, completa todos los campos correctamente');
      return;
    }

    try {
      const token = localStorage.getItem("token");
      const response = await fetch(`${BASE_URL}/admin/modify-skin`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          skin_id: currentSkinId,
          skin_name: skinName,
          skin_rarity: skinRarity,
          skin_price: skinPrice
        })
      });

      const result = await response.json();

      if (response.ok) {
        alert('Skin modificada exitosamente');
        cerrarModal();
        // Recargar las skins para mostrar los cambios
        document.getElementById('skins-container').innerHTML = '';
        cargarSkins();
      } else {
        alert(`Error: ${result.message}`);
      }

    } catch (err) {
      console.error("Error al modificar skin:", err);
      alert("Error al modificar la skin. Inténtalo de nuevo.");
    }
  }

  // Event listeners para cerrar los modales
  window.onclick = function(event) {
    const modifyModal = document.getElementById('modifyModal');
    const addModal = document.getElementById('addModal');

    if (event.target == modifyModal) {
      cerrarModal();
    }
    if (event.target == addModal) {
      cerrarModalAgregar();
    }
  }

  document.querySelectorAll('.close').forEach(closeBtn => {
    closeBtn.onclick = function() {
      cerrarModal();
      cerrarModalAgregar();
    }
  });

  // Cerrar modales con tecla Escape
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      cerrarModal();
      cerrarModalAgregar();
    }
  });

  window.onload = cargarSkins;

  document.addEventListener("DOMContentLoaded", async function () {
    const token = localStorage.getItem("token");
    if (!token) {
      navigateTo("WebMenu.html")
    }
    const userId = parseJwt(token).userId
  });
</script>
</body>
</html>