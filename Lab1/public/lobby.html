<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lobby | Plappy Pird</title>
  <script src="/env.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #ffcc00;
      --secondary-color: #ffaa00;
      --dark-accent: #222034;
      --sky-bg: #73c8f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Press Start 2P', cursive;
      background: linear-gradient(to bottom, var(--sky-bg) 0%, #e4f5fd 100%);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
      text-align: center;
    }

    h1 {
      font-size: 28px;
      color: white;
      text-shadow: 4px 4px 0px var(--dark-accent);
      margin-bottom: 30px;
    }

    .info-box {
      background-color: white;
      border: 4px dashed var(--dark-accent);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    p {
      color: var(--dark-accent);
      font-size: 12px;
      margin-bottom: 20px;
      word-break: break-word;
    }

    .button {
      font-size: 12px;
      font-family: 'Press Start 2P', cursive;
      padding: 14px 22px;
      background-color: var(--primary-color);
      color: var(--dark-accent);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 0 var(--secondary-color), 0 6px 10px rgba(0,0,0,0.2);
    }

    .button:hover {
      background-color: var(--secondary-color);
      transform: translateY(-3px);
    }

    .button:active {
      transform: translateY(3px);
    }
  </style>
</head>
<body>
<h1>Esperando jugador...</h1>
<div class="info-box" id="lobby-info">
  <!-- Botón para iniciar partida (solo visible para el host si ya hay guest) -->
  <button id="play-button" class="button" style="display: none;" onclick="startGame()">Jugar</button>

  <p>Cargando información del lobby...</p>
</div>
<button class="button" onclick="location.href='MainMenu.html'">Cancelar</button>

<script>
  const BASE_URL = window.ENV.BASE_URL;
  const token = localStorage.getItem("token");
  const lobbyId = localStorage.getItem("lobbyId");

  if (!token || !lobbyId) {
    location.href = "WebMenu.html";
  }

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) {
      return null;
    }
  }

  const user = parseJwt(token);
  let polling;

  async function getHostId() {
    try {
      const res = await fetch(`${BASE_URL}/lobby/${lobbyId}/host`);
      const data = await res.json();
      if (data.success) {
        return data.host_id;
      } else {
        console.error("Error al obtener host_id:", data.message);
        return null;
      }
    } catch (err) {
      console.error("Error al conectar con el servidor:", err);
      return null;
    }
  }

  async function getGuestId() {
    try {
      const res = await fetch(`${BASE_URL}/lobby/${lobbyId}/guest`);
      const data = await res.json();
      if (data.success) {
        return data.guest_id;
      } else {
        console.error("Error al obtener guest_id:", data.message);
        return null;
      }
    } catch (err) {
      console.error("Error al conectar con el servidor:", err);
      return null;
    }
  }

  async function getUsernameById(userId) {
    const res = await fetch(`${BASE_URL}/user/get-user-data`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    });
    const data = await res.json();
    return data.username;
  }

  // Función para iniciar el juego (actualizar estado y redirigir a gameonline.html)
  async function startGame() {
    try {
      // Actualizar el estado del lobby a "PLAYING"
      const response = await fetch(`${BASE_URL}/lobby/${lobbyId}/start`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      });

      const data = await response.json();

      if (data.success) {
        // Redirigir al host a la página del juego
        window.location.href = "gameonline.html";
      } else {
        console.error("Error al iniciar el juego:", data.message);
        alert("Error al iniciar el juego. Inténtalo de nuevo.");
      }
    } catch (error) {
      console.error("Error de conexión:", error);
      alert("Error de conexión al iniciar el juego.");
    }
  }

  async function fetchLobbyStatus(username) {
    try {
      const res = await fetch(`${BASE_URL}/lobby/${lobbyId}`);
      const data = await res.json();

      if (!data.success) {
        document.getElementById("lobby-info").innerHTML = "<p>Error al obtener el lobby</p>";
        return;
      }

      // Obtener detalles del host y guest
      const lobby = data.lobby;
      const hostId = await getHostId();
      const guestId = await getGuestId();
      const hostUsername = hostId ? await getUsernameById(hostId) : "Desconocido";
      const guestUsername = guestId ? await getUsernameById(guestId) : "Esperando jugador...";

      // Comprobar si el usuario actual es el host
      const isHost = user.userId === hostId;

      // Si el estado del lobby es "PLAYING", redirigir automáticamente al juego
      if (lobby.status === "PLAYING") {
        window.location.href = "gameonline.html";
        return;
      }

      // Actualizar el título según si hay guest o no
      document.querySelector('h1').textContent = guestId ? "¡Jugador encontrado!" : "Esperando jugador...";

      // Actualizar la información del lobby
      let lobbyInfoHTML = `
        <p><strong>ID del Lobby:</strong> ${lobby.lobby_id}</p>
        <p><strong>Host:</strong> ${hostUsername}</p>
        <p><strong>Estado:</strong> ${lobby.status}</p>
        <p><strong>Creado:</strong> ${new Date(lobby.created_at).toLocaleString()}</p>
        <p><strong>Guest:</strong> ${guestUsername}</p>
      `;

      // Añadir el botón de jugar si hay un guest y el usuario es el host
      if (hostId && guestId) {
        if (isHost) {
          lobbyInfoHTML += `<button id="play-button" class="button" onclick="startGame()">Jugar</button>`;
        } else {
          lobbyInfoHTML += `<p>Esperando a que el host inicie el juego...</p>`;
        }
      }

      document.getElementById("lobby-info").innerHTML = lobbyInfoHTML;

    } catch (err) {
      console.error(err);
      document.getElementById("lobby-info").innerHTML = "<p>Error al conectar con el servidor.</p>";
    }
  }

  async function startLobbyStatus() {
    const username = await getUsernameById(user.userId);
    polling = setInterval(() => fetchLobbyStatus(username), 2000);
    fetchLobbyStatus(username);
  }

  startLobbyStatus();
</script>
</body>
</html>